stages:
  - build
  - test
  - deploy

build-job:
  stage: build
  script:
    - docker build -t my-backend-image .

nginx-test-job:
  stage: test
  script:
    - echo "Installing file command"
    - apk add --no-cache file
    - echo "Validating nginx.conf in CI"
    - ls -l ./nginx.conf
    - file ./nginx.conf
    - cat ./nginx.conf
    # - echo "Testing with default mount"
    # - docker run --rm -v "$(pwd)/nginx.conf:/etc/nginx/nginx.conf:ro" nginx:latest nginx -t
    - echo "Testing with custom mount"
    - docker run --rm -v "$(pwd)/nginx.conf:/custom/nginx.conf:ro" nginx:latest nginx -t -c /custom/nginx.conf

backend-test-job:
  stage: test
  script:
    - echo "Testing"
    - echo "PRODUCTION = $PRODUCTION"
    - echo "ALLOWED_ORIGINS = $ALLOWED_ORIGINS"
    - echo "PRODUCTION_DB_URL = $PRODUCTION_DB_URL"
    - docker run --rm -e PRODUCTION="$PRODUCTION" -e ALLOWED_ORIGINS="$ALLOWED_ORIGINS" -e PRODUCTION_DB_URL="$PRODUCTION_DB_URL" my-backend-image pytest -s -v

deploy-job:
  stage: deploy
  script:
    - docker compose down --remove-orphans
    - docker compose up -d --force-recreate
